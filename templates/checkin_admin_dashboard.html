{% extends "base.html" %}

{% block title %}Check-in Dashboard - {{ tournament.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">üèì {{ tournament.name }}</h1>
            <p class="text-muted mb-0">Check-in Dashboard</p>
        </div>
        <div class="btn-group">
            <a href="{{ url_for('checkin.admin_import_participants', tournament_id=tournament.id) }}" class="btn btn-outline-primary">
                <i class="bi bi-upload me-1"></i> Import CSV
            </a>
            <a href="{{ url_for('checkin.admin_checkin_settings', tournament_id=tournament.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-gear me-1"></i> Settings
            </a>
            <a href="{{ url_for('checkin.admin_generate_qrcodes', tournament_id=tournament.id) }}" class="btn btn-outline-info">
                <i class="bi bi-qr-code me-1"></i> QR Codes
            </a>
            <a href="{{ url_for('checkin.staff_checkin_station', tournament_id=tournament.id) }}" class="btn btn-success" target="_blank">
                <i class="bi bi-display me-1"></i> Staff Station
            </a>
        </div>
    </div>
    
    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 bg-primary text-white">
                <div class="card-body">
                    <h6 class="text-white-50">Total Participants</h6>
                    <h2 class="mb-0">{{ stats.total }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-success text-white">
                <div class="card-body">
                    <h6 class="text-white-50">Checked In</h6>
                    <h2 class="mb-0">{{ stats.checked_in }}</h2>
                    <small>{{ (stats.checked_in / stats.total * 100)|round(1) if stats.total > 0 else 0 }}%</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-warning text-dark">
                <div class="card-body">
                    <h6 class="opacity-75">Pending</h6>
                    <h2 class="mb-0">{{ stats.pending }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-info text-white">
                <div class="card-body">
                    <h6 class="text-white-50">Packs Given</h6>
                    <h2 class="mb-0">{{ stats.packs_given }}</h2>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- By Country -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header"><i class="bi bi-globe me-2"></i>By Country</div>
                <div class="card-body p-0">
                    <table class="table table-sm mb-0">
                        <thead><tr><th>Country</th><th class="text-center">Total</th><th class="text-center">Done</th></tr></thead>
                        <tbody>
                            {% for country, data in stats.by_country|dictsort %}
                            <tr>
                                <td>{{ country }}</td>
                                <td class="text-center">{{ data.total }}</td>
                                <td class="text-center">
                                    <span class="badge bg-{{ 'success' if data.checked_in == data.total else 'secondary' }}">{{ data.checked_in }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Participants List -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-people me-2"></i>Participants</span>
                    <input type="text" id="searchInput" class="form-control form-control-sm" style="width: 200px;" placeholder="Search...">
                </div>
                <div class="card-body p-0" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover table-sm mb-0" id="participantsTable">
                        <thead class="table-light sticky-top">
                            <tr><th>Name</th><th>Country</th><th>Email</th><th class="text-center">Status</th><th class="text-center">T-Shirt</th><th class="text-center">Pack</th></tr>
                        </thead>
                        <tbody>
                            {% for p in participants %}
                            <tr class="participant-row" data-name="{{ p.first_name }} {{ p.last_name }}">
                                <td><strong>{{ p.first_name }} {{ p.last_name }}</strong></td>
                                <td>{{ p.country or '‚Äî' }}</td>
                                <td><small>{{ p.email or '‚Äî' }}</small></td>
                                <td class="text-center">
                                    {% if p.is_checked_in %}<span class="badge bg-success">‚úì</span>
                                    {% else %}<span class="badge bg-secondary">‚Äî</span>{% endif %}
                                </td>
                                <td class="text-center">{% if p.checkin %}{{ p.checkin.tshirt_size or '‚Äî' }}{% else %}‚Äî{% endif %}</td>
                                <td class="text-center">
                                    {% if p.checkin and p.checkin.welcome_pack_received %}<span class="badge bg-success">‚úì</span>
                                    {% elif p.checkin %}<button class="btn btn-sm btn-outline-primary mark-pack-btn" data-checkin-id="{{ p.checkin.id }}">Give</button>
                                    {% else %}<span class="text-muted">‚Äî</span>{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('searchInput').addEventListener('input', function() {
    const filter = this.value.toLowerCase();
    document.querySelectorAll('.participant-row').forEach(row => {
        row.style.display = row.dataset.name.toLowerCase().includes(filter) ? '' : 'none';
    });
});

document.querySelectorAll('.mark-pack-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const checkinId = this.dataset.checkinId;
        const resp = await fetch(`/api/tournament/{{ tournament.id }}/checkin/${checkinId}/pack`, {method: 'POST'});
        if (resp.ok) this.outerHTML = '<span class="badge bg-success">‚úì</span>';
    });
});
</script>
{% endblock %}
