{% extends "base.html" %}
{% block title %}Scoring Setup - {{ tournament.name }}{% endblock %}
{% block content %}
<div class="container">
    <nav aria-label="breadcrumb"><ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
        <li class="breadcrumb-item active">Scoring Setup</li>
    </ol></nav>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-clipboard-data"></i> Scoring Setup - {{ tournament.name }}</h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('scoring.live_dashboard', tournament_id=tournament.id) }}" class="btn btn-danger"><i class="bi bi-activity"></i> Live Dashboard</a>
            <a href="{{ url_for('scoring.court_links', tournament_id=tournament.id) }}" class="btn btn-outline-primary"><i class="bi bi-qr-code"></i> Court Links</a>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-geo-alt"></i> Courts ({{ courts|length }})</h5></div>
                <div class="card-body">
                    {% if courts %}
                    <table class="table table-sm align-middle">
                        <thead><tr><th style="width:40px">#</th><th>Manager</th><th style="width:55px">Status</th><th style="width:50px">Spiele</th></tr></thead>
                        <tbody>
                        {% for court in courts %}
                        <tr>
                            <td><strong>{{ court.court_number }}</strong></td>
                            <td>
                                <form method="POST" action="{{ url_for('scoring.update_court_name', court_id=court.id) }}" class="d-flex gap-1">
                                    <input type="text" name="manager_name" class="form-control form-control-sm" value="{{ court.manager_name or '' }}" placeholder="Name" style="min-width:90px">
                                    <button type="submit" class="btn btn-sm btn-outline-primary p-0 px-1"><i class="bi bi-check-lg"></i></button>
                                </form>
                            </td>
                            <td>{% if court.status == 'in_play' %}<span class="badge bg-danger">LIVE</span>{% else %}<span class="badge bg-success">Frei</span>{% endif %}</td>
                            <td>{{ court.matches.count() }}</td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% else %}<p class="text-muted">Keine Courts.</p>{% endif %}
                    <hr>
                    <form method="POST" action="{{ url_for('scoring.create_courts', tournament_id=tournament.id) }}">
                        <div class="input-group input-group-sm">
                            <input type="number" name="num_courts" class="form-control" value="9" min="1" max="30">
                            <div class="input-group-text"><input type="checkbox" name="replace_existing" class="form-check-input mt-0"> Ersetzen</div>
                            <button type="submit" class="btn btn-primary btn-sm">Courts erstellen</button>
                        </div>
                    </form>
                </div>
            </div>
            {% if courts %}
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-person-badge"></i> Schnellzuweisung</h5></div>
                <div class="card-body">
                    <p class="text-muted small mb-2">Gleichen Manager mehreren Courts zuweisen:</p>
                    <form method="POST" action="{{ url_for('scoring.assign_manager', tournament_id=tournament.id) }}">
                        <div class="mb-2"><input type="text" name="manager_name" class="form-control form-control-sm" placeholder="Name" required></div>
                        <div class="mb-2">
                            {% for court in courts %}
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="court_ids" value="{{ court.id }}" id="mc{{ court.id }}">
                                <label class="form-check-label" for="mc{{ court.id }}">C{{ court.court_number }}</label>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="submit" class="btn btn-sm btn-outline-primary"><i class="bi bi-check2"></i> Zuweisen</button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="col-lg-8">
            <div class="card mb-4 border-primary">
                <div class="card-header bg-primary text-white"><h5 class="mb-0"><i class="bi bi-lightning"></i> Smart Import (pickleball.global)</h5></div>
                <div class="card-body">
                    <p class="text-muted small">Kopiere den kompletten Spielplan von pickleball.global und fuege ihn hier ein.</p>
                    <form method="POST" action="{{ url_for('scoring.smart_import', tournament_id=tournament.id) }}">
                        <div class="mb-2"><label class="form-label">Turniertag (Datum)</label><input type="date" name="base_date" class="form-control" value="2026-02-25"></div>
                        <div class="mb-2"><label class="form-label">Spielplan einfuegen</label>
                        <textarea name="schedule_text" class="form-control" rows="10" placeholder="Hier den kompletten Spielplan von pickleball.global einfuegen..."></textarea></div>
                        <button type="submit" class="btn btn-primary"><i class="bi bi-lightning"></i> Importieren</button>
                    </form>
                </div>
            </div>
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-ol"></i> Matches ({{ matches|length }})</h5>
                    {% if matches %}
                    <form method="POST" action="{{ url_for('scoring.clear_matches', tournament_id=tournament.id) }}" onsubmit="return confirm('ALLE Matches loeschen?')">
                        <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> Alle loeschen</button>
                    </form>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    {% if matches %}
                    <div class="table-responsive"><table class="table table-sm table-hover mb-0"><thead><tr><th>#</th><th>Kat.</th><th>Team 1</th><th>Team 2</th><th>Court</th><th>Zeit</th><th>Score</th><th>Status</th><th></th></tr></thead><tbody>
                    {% for match in matches %}
                    <tr>
                        <td><small>{{ match.match_number }}</small></td>
                        <td><small>{{ match.category or '-' }}</small></td>
                        <td>{% if match.team1_score is not none and match.team1_score > match.team2_score %}<strong>{{ match.get_team1_display() }}</strong>{% else %}{{ match.get_team1_display() }}{% endif %}</td>
                        <td>{% if match.team2_score is not none and match.team2_score > match.team1_score %}<strong>{{ match.get_team2_display() }}</strong>{% else %}{{ match.get_team2_display() }}{% endif %}</td>
                        <td>{% if match.court %}C{{ match.court.court_number }}{% elif match.court_number %}C{{ match.court_number }}{% else %}-{% endif %}</td>
                        <td><small>{{ match.scheduled_time.strftime('%H:%M') if match.scheduled_time else '-' }}</small></td>
                        <td>{% if match.team1_score is not none %}<strong>{{ match.team1_score }}-{{ match.team2_score }}</strong>{% else %}-{% endif %}</td>
                        <td>{% if match.status == 'completed' %}<span class="badge bg-success">OK</span>{% elif match.status == 'in_play' %}<span class="badge bg-danger">LIVE</span>{% else %}<span class="badge bg-secondary">Plan</span>{% endif %}</td>
                        <td><form method="POST" action="{{ url_for('scoring.delete_match', match_id=match.id) }}" style="display:inline" onsubmit="return confirm('Loeschen?')"><button class="btn btn-sm btn-outline-danger p-0 px-1"><i class="bi bi-x"></i></button></form></td>
                    </tr>
                    {% endfor %}
                    </tbody></table></div>
                    {% else %}<div class="text-center text-muted py-4">Noch keine Matches. Nutze den Smart Import oben!</div>{% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
