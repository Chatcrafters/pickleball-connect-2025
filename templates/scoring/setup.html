{% extends "base.html" %}
{% block title %}Scoring Setup - {{ tournament.name }}{% endblock %}
{% block content %}
<div class="container">
    <nav aria-label="breadcrumb"><ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
        <li class="breadcrumb-item active">Scoring Setup</li>
    </ol></nav>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-clipboard-data"></i> {{ tournament.name }}</h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('scoring.results_overview', tournament_id=tournament.id) }}" class="btn btn-success"><i class="bi bi-table"></i> Ergebnisse (PG)</a>
            <a href="{{ url_for('scoring.live_dashboard', tournament_id=tournament.id) }}" class="btn btn-danger"><i class="bi bi-activity"></i> Live</a>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-5">
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-geo-alt"></i> Courts & Manager ({{ courts|length }})</h5></div>
                <div class="card-body p-0">
                    {% if courts %}
                    <table class="table table-sm align-middle mb-0">
                        <thead><tr><th style="width:35px">#</th><th>Manager</th><th>Telefon</th><th style="width:35px"></th><th style="width:40px">Sp.</th></tr></thead>
                        <tbody>
                        {% for court in courts %}
                        <tr>
                            <td><strong>{{ court.court_number }}</strong></td>
                            <td colspan="2">
                                <form method="POST" action="{{ url_for('scoring.update_court', court_id=court.id) }}" class="d-flex gap-1">
                                    <input type="text" name="manager_name" class="form-control form-control-sm" value="{{ court.manager_name or '' }}" placeholder="Name" style="width:45%">
                                    <input type="text" name="phone" class="form-control form-control-sm" value="{{ court.phone or '' }}" placeholder="+34..." style="width:40%">
                                    <button type="submit" class="btn btn-sm btn-outline-primary p-0 px-1"><i class="bi bi-check-lg"></i></button>
                                </form>
                            </td>
                            <td></td>
                            <td>{{ court.matches.count() }}</td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% else %}<div class="p-3 text-muted">Keine Courts.</div>{% endif %}
                </div>
                <div class="card-footer">
                    <form method="POST" action="{{ url_for('scoring.create_courts', tournament_id=tournament.id) }}">
                        <div class="input-group input-group-sm">
                            <input type="number" name="num_courts" class="form-control" value="9" min="1" max="30">
                            <div class="input-group-text"><input type="checkbox" name="replace_existing" class="form-check-input mt-0"> Ersetzen</div>
                            <button type="submit" class="btn btn-primary btn-sm">Courts erstellen</button>
                        </div>
                    </form>
                </div>
            </div>
            {% if courts %}
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-person-badge"></i> Schnellzuweisung</h5></div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('scoring.assign_manager', tournament_id=tournament.id) }}">
                        <div class="row g-2 mb-2">
                            <div class="col-7"><input type="text" name="manager_name" class="form-control form-control-sm" placeholder="Name" required></div>
                            <div class="col-5"><input type="text" name="phone" class="form-control form-control-sm" placeholder="+34..."></div>
                        </div>
                        <div class="mb-2">{% for court in courts %}<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" name="court_ids" value="{{ court.id }}" id="mc{{ court.id }}"><label class="form-check-label" for="mc{{ court.id }}">C{{ court.court_number }}</label></div>{% endfor %}</div>
                        <button type="submit" class="btn btn-sm btn-outline-primary"><i class="bi bi-check2"></i> Zuweisen</button>
                    </form>
                </div>
            </div>
            {% endif %}
            {% if managers %}
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-send"></i> Links per WhatsApp</h5></div>
                <div class="card-body p-0">
                    <table class="table table-sm mb-0">{% for name, info in managers.items() %}<tr><td><strong>{{ name }}</strong></td><td>C{{ info.courts|map(attribute='court_number')|join(', C') }}</td><td>{{ info.phone or '-' }}</td><td><a href="{{ url_for('scoring.send_whatsapp_link', tournament_id=tournament.id, manager_name=name) }}" class="btn btn-sm btn-success p-0 px-2" target="_blank"><i class="bi bi-whatsapp"></i></a></td></tr>{% endfor %}</table>
                </div>
            </div>
            {% endif %}
        </div>
