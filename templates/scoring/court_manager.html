{% extends "base.html" %}

{% block title %}Court {{ court.court_number }} - {{ tournament.name }}{% endblock %}

{% block extra_head %}
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<style>
    body { background: #1a1a2e; }
    .navbar { display: none; }
    footer { display: none; }
    .court-header {
        background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
        color: #fff; padding: 1rem; text-align: center;
        position: sticky; top: 0; z-index: 100;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .court-header h1 { font-size: 1.5rem; margin: 0; font-weight: 700; }
    .court-header .event-name { font-size: 0.85rem; opacity: 0.8; }
    .match-card {
        background: #16213e; border-radius: 12px; padding: 1.25rem;
        margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.1); color: #fff;
    }
    .match-card.active { border: 2px solid #e94560; box-shadow: 0 0 20px rgba(233,69,96,0.3); }
    .match-card.completed { opacity: 0.85; border-color: rgba(83,217,145,0.3); }
    .team-name { font-size: 1.1rem; font-weight: 600; color: #fff; }
    .vs-divider { color: #e94560; font-weight: 700; font-size: 0.9rem; }
    .match-meta { font-size: 0.8rem; color: rgba(255,255,255,0.5); }
    .score-input-group {
        display: flex; align-items: center; gap: 0.75rem;
        justify-content: center; margin: 1rem 0;
    }
    .score-input {
        width: 80px; height: 70px; font-size: 2rem; font-weight: 700;
        text-align: center; border: 2px solid rgba(255,255,255,0.2);
        border-radius: 12px; background: #0f3460; color: #fff;
    }
    .score-input:focus { border-color: #e94560; outline: none; box-shadow: 0 0 0 3px rgba(233,69,96,0.3); }
    .score-separator { font-size: 2rem; font-weight: 700; color: rgba(255,255,255,0.5); }
    .score-team-label {
        font-size: 0.75rem; color: rgba(255,255,255,0.6); text-align: center;
        max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .quick-score { display: flex; gap: 0.4rem; justify-content: center; margin-bottom: 0.25rem; }
    .quick-score .btn { width: 38px; height: 38px; padding: 0; font-size: 0.9rem; font-weight: 600; border-radius: 8px; }
    .btn-action { width: 100%; padding: 0.9rem; font-size: 1.1rem; font-weight: 600; border-radius: 10px; border: none; }
    .btn-start { background: #53d991; color: #1a1a2e; }
    .btn-start:hover, .btn-start:active { background: #43c981; color: #1a1a2e; }
    .btn-submit-score { background: #e94560; color: #fff; }
    .btn-submit-score:hover, .btn-submit-score:active { background: #d93550; color: #fff; }
    .btn-claim { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
    .score-display { font-size: 2.5rem; font-weight: 700; text-align: center; }
    .score-display .winner { color: #53d991; }
    .score-display .loser { color: rgba(255,255,255,0.4); }
    .section-title {
        color: rgba(255,255,255,0.5); font-size: 0.8rem; text-transform: uppercase;
        letter-spacing: 1px; margin: 1.5rem 0 0.75rem; padding-left: 0.25rem;
    }
    .empty-state { text-align: center; color: rgba(255,255,255,0.4); padding: 2rem 1rem; font-size: 0.95rem; }
    main.container-fluid { padding: 0 !important; max-width: 500px; margin: 0 auto; }
    .content-area { padding: 0.75rem; }
    .flash-message { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
</style>
{% endblock %}

{% block content %}
<div class="court-header">
    <div class="event-name">{{ tournament.name }}</div>
    <h1><i class="bi bi-clipboard-check"></i> Court {{ court.court_number }}
        {% if court.court_name %} - {{ court.court_name }}{% endif %}
    </h1>
    {% if court.manager_name %}
    <div class="event-name">Court Manager: {{ court.manager_name }}</div>
    {% endif %}
</div>

<div class="content-area">
    {% if current_match %}
    <div class="section-title">Aktuelles Spiel</div>
    <div class="match-card active">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="match-meta">Match #{{ current_match.match_number }}{% if current_match.category %} | {{ current_match.category }}{% endif %}</span>
            <span class="badge bg-danger">LIVE</span>
        </div>
        <div class="text-center mb-2">
            <div class="team-name">{{ current_match.get_team1_display() }}</div>
            <div class="vs-divider my-1">VS</div>
            <div class="team-name">{{ current_match.get_team2_display() }}</div>
        </div>
        {% if current_match.started_at %}
        <div class="match-meta text-center mb-3">Gestartet: {{ current_match.started_at.strftime('%H:%M') }}</div>
        {% endif %}
        <form method="POST" action="{{ url_for('scoring.submit_score', token=token, match_id=current_match.id) }}" onsubmit="return confirmScore(this)">
            <div class="score-input-group">
                <div>
                    <div class="score-team-label">{{ current_match.get_team1_display().split('/')[0] if '/' in current_match.get_team1_display() else current_match.get_team1_display().split(' ')[0] }}</div>
                    <div class="quick-score">
                        <button type="button" class="btn btn-outline-light" onclick="setScore('score1', 0)">0</button>
                        <button type="button" class="btn btn-outline-light" onclick="setScore('score1', 7)">7</button>
                        <button type="button" class="btn btn-outline-light" onclick="setScore('score1', 9)">9</button>
                        <button type="button" class="btn btn-outline-warning" onclick="setScore('score1', 11)">11</button>
                    </div>
                    <input type="number" name="score_team1" id="score1" class="score-input" min="0" max="15" required inputmode="numeric" autocomplete="off">
                </div>
                <div class="score-separator">:</div>
                <div>
                    <div class="score-team-label">{{ current_match.get_team2_display().split('/')[0] if '/' in current_match.get_team2_display() else current_match.get_team2_display().split(' ')[0] }}</div>
                    <div class="quick-score">
                        <button type="button" class="btn btn-outline-light" onclick="setScore('score2', 0)">0</button>
                        <button type="button" class="btn btn-outline-light" onclick="setScore('score2', 7)">7</button>
                        <button type="button" class="btn btn-outline-light" onclick="setScore('score2', 9)">9</button>
                        <button type="button" class="btn btn-outline-warning" onclick="setScore('score2', 11)">11</button>
                    </div>
                    <input type="number" name="score_team2" id="score2" class="score-input" min="0" max="15" required inputmode="numeric" autocomplete="off">
                </div>
            </div>
            <div class="mb-3">
                <input type="text" name="notes" class="form-control bg-dark text-light border-secondary" placeholder="Anmerkungen (optional)" style="font-size: 0.85rem;">
            </div>
            <button type="submit" class="btn btn-action btn-submit-score"><i class="bi bi-send-fill"></i> Score Senden</button>
        </form>
    </div>
    {% endif %}

    {% if scheduled_matches %}
    <div class="section-title">Naechste Spiele auf diesem Court</div>
    {% for match in scheduled_matches %}
    <div class="match-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="match-meta">Match #{{ match.match_number }}{% if match.category %} | {{ match.category }}{% endif %}</span>
            {% if match.scheduled_time %}<span class="match-meta">{{ match.scheduled_time.strftime('%H:%M') }}</span>{% endif %}
        </div>
        <div class="text-center mb-3">
            <div class="team-name">{{ match.get_team1_display() }}</div>
            <div class="vs-divider my-1">VS</div>
            <div class="team-name">{{ match.get_team2_display() }}</div>
        </div>
        {% if not current_match %}
        <form method="POST" action="{{ url_for('scoring.start_match', token=token, match_id=match.id) }}">
            <button type="submit" class="btn btn-action btn-start"><i class="bi bi-play-fill"></i> Spiel Starten</button>
        </form>
        {% else %}
        <div class="text-center match-meta"><i class="bi bi-clock"></i> Wartet auf aktuelles Spiel</div>
        {% endif %}
    </div>
    {% endfor %}
    {% endif %}

    {% if unassigned_matches and not current_match %}
    <div class="section-title">Verfuegbare Spiele (nicht zugewiesen)</div>
    {% for match in unassigned_matches[:5] %}
    <div class="match-card" style="border-style: dashed;">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="match-meta">Match #{{ match.match_number }}{% if match.category %} | {{ match.category }}{% endif %}</span>
        </div>
        <div class="text-center mb-3">
            <div class="team-name" style="font-size: 0.95rem;">{{ match.get_team1_display() }}</div>
            <div class="vs-divider my-1">VS</div>
            <div class="team-name" style="font-size: 0.95rem;">{{ match.get_team2_display() }}</div>
        </div>
        <form method="POST" action="{{ url_for('scoring.claim_match', token=token, match_id=match.id) }}">
            <button type="submit" class="btn btn-action btn-claim"><i class="bi bi-plus-circle"></i> Fuer diesen Court uebernehmen</button>
        </form>
    </div>
    {% endfor %}
    {% if unassigned_matches|length > 5 %}
    <div class="text-center match-meta mb-3">+ {{ unassigned_matches|length - 5 }} weitere verfuegbare Spiele</div>
    {% endif %}
    {% endif %}

    {% if not current_match and not scheduled_matches and not unassigned_matches %}
    <div class="empty-state">
        <i class="bi bi-check-circle" style="font-size: 3rem; display: block; margin-bottom: 1rem; color: #53d991;"></i>
        <div>Keine Spiele ausstehend</div>
        <div style="font-size: 0.8rem; margin-top: 0.5rem;">Warte auf neue Spielzuweisungen</div>
    </div>
    {% endif %}

    {% if completed_matches %}
    <div class="section-title">Letzte Ergebnisse</div>
    {% for match in completed_matches %}
    <div class="match-card completed">
        <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="match-meta">Match #{{ match.match_number }}{% if match.category %} | {{ match.category }}{% endif %}</span>
            <span class="match-meta">{{ match.completed_at.strftime('%H:%M') if match.completed_at else '' }}{% if match.scoresheet_verified %}<i class="bi bi-patch-check-fill text-success ms-1"></i>{% endif %}</span>
        </div>
        <div class="score-display" style="font-size: 1.3rem;">
            <span class="{{ 'winner' if match.team1_score > match.team2_score else 'loser' }}">{{ match.get_team1_display() }}</span>
            <span class="mx-2" style="color: rgba(255,255,255,0.3);">{{ match.team1_score }} : {{ match.team2_score }}</span>
            <span class="{{ 'winner' if match.team2_score > match.team1_score else 'loser' }}">{{ match.get_team2_display() }}</span>
        </div>
    </div>
    {% endfor %}
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function setScore(inputId, value) {
    document.getElementById(inputId).value = value;
    document.getElementById(inputId).focus();
}
function confirmScore(form) {
    const s1 = form.score_team1.value;
    const s2 = form.score_team2.value;
    if (!s1 || !s2) { alert('Bitte beide Scores eingeben!'); return false; }
    const score1 = parseInt(s1); const score2 = parseInt(s2);
    if (score1 === score2) { alert('Unentschieden ist nicht moeglich!'); return false; }
    if (score1 < 11 && score2 < 11) { if (!confirm('Keines der Teams hat 11 Punkte erreicht. Trotzdem senden?')) return false; }
    const team1 = '{{ current_match.get_team1_display() if current_match else "" }}';
    const team2 = '{{ current_match.get_team2_display() if current_match else "" }}';
    return confirm('Score bestaetigen:\n' + team1 + '  ' + score1 + ' : ' + score2 + '  ' + team2);
}
setInterval(function() {
    const s1 = document.getElementById('score1');
    const s2 = document.getElementById('score2');
    if ((!s1 || !s1.value) && (!s2 || !s2.value)) { location.reload(); }
}, 30000);
</script>
{% endblock %}
