{% extends "base.html" %}

{% block title %}Player Cards - {{ team.country_flag }} {{ team.country_name }} {{ team.age_category }}{% endblock %}

{% block content %}
<style>
    .generator-container {
        background: #1a1a2e;
        color: white;
        min-height: 100vh;
        margin: -20px;
        padding: 20px;
    }
    
    .card-scale {
        transform: scale(0.333);
        transform-origin: top left;
    }
    
    .card-container {
        width: 360px;
        height: 360px;
        overflow: hidden;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    
    /* ==================== PCL EUROPE CARD ==================== */
    .player-card-pcl {
        width: 1080px;
        height: 1080px;
        background: linear-gradient(135deg, #1a4a5e 0%, #2d6a7e 25%, #e86c3a 75%, #f4a03a 100%);
        position: relative;
        overflow: hidden;
        font-family: 'Montserrat', sans-serif;
    }
    
    .player-card-pcl .venue-silhouette {
        position: absolute;
        bottom: 280px;
        left: 50%;
        transform: translateX(-50%);
        width: 900px;
        height: 450px;
        opacity: 0.30;
        z-index: 1;
        pointer-events: none;
    }
    
    .player-card-pcl .header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 140px;
        background: rgba(0,0,0,0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 50px;
        z-index: 10;
    }
    
    .player-card-pcl .logo-text {
        color: white;
        font-size: 42px;
        font-weight: 900;
        letter-spacing: 2px;
    }
    
    .player-card-pcl .logo-text span { color: #f4a03a; }
    
    .player-card-pcl .flag-container {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .player-card-pcl .flag { font-size: 60px; }
    
    .player-card-pcl .country-name {
        font-size: 28px;
        font-weight: 700;
        color: white;
        text-transform: uppercase;
    }
    
    .player-card-pcl .age-category {
        background: #f4a03a;
        color: #1a1a2e;
        padding: 8px 25px;
        border-radius: 25px;
        font-size: 32px;
        font-weight: 900;
    }
    
    .player-card-pcl .category-badge {
        position: absolute;
        top: 115px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        color: #f4a03a;
        padding: 10px 40px;
        border-radius: 30px;
        font-size: 28px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
        z-index: 10;
    }
    
    .player-card-pcl .photo-circle {
        position: absolute;
        top: 160px;
        left: 50%;
        transform: translateX(-50%);
        width: 450px;
        height: 450px;
        border-radius: 50%;
        border: 8px solid rgba(255,255,255,0.3);
        background-color: #2d6a7e;
        background-size: cover;
        background-repeat: no-repeat;
        z-index: 5;
    }
    
    .player-card-pcl .photo-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 150px;
        color: rgba(255,255,255,0.3);
    }
    
    .player-card-pcl .info-section {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 380px;
        background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 60%, transparent 100%);
        padding: 120px 50px 40px;
        text-align: center;
        z-index: 8;
    }
    
    .player-card-pcl .shirt-name {
        font-size: 72px;
        font-weight: 900;
        color: #f4a03a;
        text-transform: uppercase;
        letter-spacing: 3px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .player-card-pcl .full-name {
        font-size: 32px;
        font-weight: 400;
        color: white;
        margin-top: 5px;
    }
    
    .player-card-pcl .tagline {
        font-size: 28px;
        color: #f4a03a;
        margin-top: 15px;
        font-weight: 700;
        font-style: italic;
    }
    
    .player-card-pcl .venue-name {
        font-size: 18px;
        color: rgba(255,255,255,0.6);
        margin-top: 8px;
        letter-spacing: 2px;
        text-transform: uppercase;
    }
    
    .player-card-pcl .social {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 15px;
        font-size: 26px;
        color: #f4a03a;
    }
    
    .player-card-pcl .social span {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* PCL DOUBLES */
    .player-card-pcl.doubles-card .photo-circle { display: none; }
    
    .player-card-pcl.doubles-card .doubles-photos {
        position: absolute;
        top: 200px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 30px;
        z-index: 5;
    }
    
    .player-card-pcl.doubles-card .player-photo {
        width: 320px;
        height: 320px;
        border-radius: 50%;
        border: 6px solid rgba(255,255,255,0.3);
        background-color: rgba(0,0,0,0.3);
        background-size: cover;
        background-repeat: no-repeat;
    }
    
    .player-card-pcl.doubles-card .info-section { height: 420px; padding-top: 140px; }
    .player-card-pcl.doubles-card .shirt-name { font-size: 56px; }
    .player-card-pcl.doubles-card .full-name { font-size: 28px; }
    
    /* ==================== WPC SERIES CARD ==================== */
    .player-card-wpc {
        width: 1080px;
        height: 1080px;
        background: linear-gradient(135deg, #4a7c3f 0%, #5a9a4a 50%, #3d6a32 100%);
        position: relative;
        overflow: hidden;
        font-family: 'Montserrat', sans-serif;
    }
    
    .player-card-wpc .venue-silhouette {
        position: absolute;
        bottom: 280px;
        left: 50%;
        transform: translateX(-50%);
        width: 900px;
        height: 450px;
        opacity: 0.30;
        z-index: 1;
        pointer-events: none;
    }
    
    .player-card-wpc .header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 140px;
        background: rgba(0,0,0,0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 50px;
        z-index: 10;
    }
    
    .player-card-wpc .logo-text {
        color: white;
        font-size: 42px;
        font-weight: 900;
        letter-spacing: 2px;
    }
    
    .player-card-wpc .logo-text span { color: #f4a03a; }
    
    .player-card-wpc .flag-container {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .player-card-wpc .flag { font-size: 60px; }
    
    .player-card-wpc .country-name {
        font-size: 28px;
        font-weight: 700;
        color: white;
        text-transform: uppercase;
    }
    
    .player-card-wpc .age-category {
        background: #f4a03a;
        color: #1a1a2e;
        padding: 8px 25px;
        border-radius: 25px;
        font-size: 32px;
        font-weight: 900;
    }
    
    .player-card-wpc .category-badge {
        position: absolute;
        top: 115px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        color: #f4a03a;
        padding: 10px 40px;
        border-radius: 30px;
        font-size: 28px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
        z-index: 10;
    }
    
    .player-card-wpc .photo-circle {
        position: absolute;
        top: 160px;
        left: 50%;
        transform: translateX(-50%);
        width: 450px;
        height: 450px;
        border-radius: 50%;
        border: 8px solid rgba(255,255,255,0.3);
        background-color: #3d6a32;
        background-size: cover;
        background-repeat: no-repeat;
        z-index: 5;
    }
    
    .player-card-wpc .photo-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 150px;
        color: rgba(255,255,255,0.3);
    }
    
    .player-card-wpc .info-section {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 380px;
        background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 60%, transparent 100%);
        padding: 120px 50px 40px;
        text-align: center;
        z-index: 8;
    }
    
    .player-card-wpc .shirt-name {
        font-size: 72px;
        font-weight: 900;
        color: #f4a03a;
        text-transform: uppercase;
        letter-spacing: 3px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .player-card-wpc .full-name {
        font-size: 32px;
        font-weight: 400;
        color: white;
        margin-top: 5px;
    }
    
    .player-card-wpc .tagline {
        font-size: 28px;
        color: #f4a03a;
        margin-top: 15px;
        font-weight: 700;
        font-style: italic;
    }
    
    .player-card-wpc .venue-name {
        font-size: 18px;
        color: rgba(255,255,255,0.6);
        margin-top: 8px;
        letter-spacing: 2px;
        text-transform: uppercase;
    }
    
    .player-card-wpc .social {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 15px;
        font-size: 26px;
        color: #f4a03a;
    }
    
    .player-card-wpc .social span {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* WPC DOUBLES */
    .player-card-wpc.doubles-card .photo-circle { display: none; }
    
    .player-card-wpc.doubles-card .doubles-photos {
        position: absolute;
        top: 200px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 30px;
        z-index: 5;
    }
    
    .player-card-wpc.doubles-card .player-photo {
        width: 320px;
        height: 320px;
        border-radius: 50%;
        border: 6px solid rgba(255,255,255,0.3);
        background-color: rgba(0,0,0,0.3);
        background-size: cover;
        background-repeat: no-repeat;
    }
    
    .player-card-wpc.doubles-card .info-section { height: 420px; padding-top: 140px; }
    .player-card-wpc.doubles-card .shirt-name { font-size: 56px; }
    .player-card-wpc.doubles-card .full-name { font-size: 28px; }
    
    /* ==================== UI STYLES ==================== */
    .form-section {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 15px;
    }
    
    .form-section h5 {
        color: #ffd700;
        margin-bottom: 12px;
        font-size: 16px;
    }
    
    .category-btn {
        padding: 10px 16px;
        border: 2px solid #555;
        background: transparent;
        color: white;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
        margin: 3px;
        font-size: 13px;
    }
    
    .category-btn:hover { border-color: #f4a03a; color: #f4a03a; }
    .category-btn.active { background: #f4a03a; color: #1a1a2e; border-color: #f4a03a; }
    
    .player-select-card {
        background: rgba(255,255,255,0.05);
        border: 2px solid transparent;
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 6px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .player-select-card:hover { border-color: #f4a03a; }
    .player-select-card.selected { border-color: #f4a03a; background: rgba(244,160,58,0.2); }
    
    .player-select-card img {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .player-select-card .placeholder-img {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .preview-container { display: flex; justify-content: center; }
    .preview-wrapper { text-align: center; }
    .preview-wrapper h5 { color: #ffd700; margin-bottom: 10px; }
    
    .nav-tabs .nav-link {
        color: #aaa;
        background: transparent;
        border: none;
        padding: 12px 20px;
    }
    
    .nav-tabs .nav-link.active {
        color: #f4a03a;
        background: rgba(244,160,58,0.2);
        border-bottom: 3px solid #f4a03a;
    }
    
    .tagline-input, .venue-select {
        background: rgba(255,255,255,0.1);
        border: 1px solid #555;
        color: white;
    }
    
    .tagline-input:focus, .venue-select:focus {
        background: rgba(255,255,255,0.15);
        border-color: #f4a03a;
        color: white;
    }
    
    .tagline-input::placeholder { color: #888; }
    .venue-select option { background: #1a1a2e; color: white; }
    
    .form-range::-webkit-slider-thumb { background: #f4a03a; }
    .form-range::-moz-range-thumb { background: #f4a03a; border: none; }
    
    .venue-badge {
        display: inline-block;
        background: linear-gradient(135deg, #e86c3a, #f4a03a);
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
    }
    
    .venue-badge.no-venue { background: #555; }
</style>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<div class="generator-container">
    <div class="container-fluid">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <a href="{{ url_for('pcl.admin_team_detail', team_id=team.id) }}" class="btn btn-outline-light btn-sm mb-2">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
                <h2 class="mb-0" style="font-size: 24px;">
                    <i class="bi bi-card-image"></i> Player Cards
                    <span class="venue-badge" id="venueBadge"><i class="bi bi-geo-alt"></i> <span id="venueBadgeText">MÃ¡laga</span></span>
                </h2>
                <p class="text-muted mb-0 small">{{ team.country_flag }} {{ team.country_name }} {{ team.age_category }}</p>
            </div>
        </div>
        
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#createTab">
                    <i class="bi bi-person"></i> Create
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#teamTab">
                    <i class="bi bi-people"></i> Team ZIP
                </button>
            </li>
        </ul>
        
        <div class="tab-content">
            <!-- CREATE TAB -->
            <div class="tab-pane fade show active" id="createTab">
                <div class="row">
                    <div class="col-lg-5">
                        <!-- Venue & Brand -->
                        <div class="form-section">
                            <h5><i class="bi bi-geo-alt"></i> Venue & Brand</h5>
                            <div class="row">
                                <div class="col-7">
                                    <select class="form-select form-select-sm venue-select" id="venueSelect" onchange="changeVenue()">
                                        <option value="none">Kein Venue</option>
                                        <option value="malaga" selected>ðŸ‡ªðŸ‡¸ MÃ¡laga - Palacio MartÃ­n Carpena</option>
                                        <option value="istanbul">ðŸ‡¹ðŸ‡· Istanbul - Hagia Sophia</option>
                                        <option value="algarve">ðŸ‡µðŸ‡¹ Algarve - Ponta da Piedade</option>
                                        <option value="alba">ðŸ‡®ðŸ‡¹ Alba - Piemont</option>
                                        <option value="marrakech">ðŸ‡²ðŸ‡¦ Marrakesch - Koutoubia</option>
                                    </select>
                                </div>
                                <div class="col-5">
                                    <select class="form-select form-select-sm" id="brandSelect" onchange="changeBrand()">
                                        <option value="pcl">PCL Europe</option>
                                        <option value="wpc">WPC Series</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Category -->
                        <div class="form-section">
                            <h5><i class="bi bi-trophy"></i> Category</h5>
                            <div class="d-flex flex-wrap">
                                <button class="category-btn active" onclick="selectCategory('singles', this)">Singles</button>
                                <button class="category-btn" onclick="selectCategory('mens-doubles', this)">Men's Dbl</button>
                                <button class="category-btn" onclick="selectCategory('womens-doubles', this)">Women's Dbl</button>
                                <button class="category-btn" onclick="selectCategory('mixed-doubles', this)">Mixed Dbl</button>
                            </div>
                            <div class="mt-1 text-warning small" id="categoryHint">Select 1 player</div>
                        </div>
                        
                        <!-- Players -->
                        <div class="form-section">
                            <h5><i class="bi bi-person-check"></i> Player(s)</h5>
                            <div style="max-height: 150px; overflow-y: auto;" id="playerList">
                                {% for reg in registrations %}
                                <div class="player-select-card" onclick="togglePlayer(this, {{ reg.id }})" data-id="{{ reg.id }}" data-gender="{{ reg.gender }}">
                                    <div class="d-flex align-items-center gap-2">
                                        {% if reg.photo_filename %}
                                        <img src="{{ reg.photo_filename }}">
                                        {% else %}
                                        <div class="placeholder-img"><i class="bi bi-person"></i></div>
                                        {% endif %}
                                        <div>
                                            <strong style="font-size: 14px;">{{ reg.shirt_name or reg.first_name|upper }}</strong>
                                            <span class="badge bg-{{ 'primary' if reg.gender == 'male' else 'danger' }} ms-1" style="font-size: 10px;">{{ 'â™‚' if reg.gender == 'male' else 'â™€' }}</span>
                                            <br><small class="text-muted">{{ reg.first_name }} {{ reg.last_name }}</small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Options -->
                        <div class="form-section">
                            <h5><i class="bi bi-sliders"></i> Options</h5>
                            <input type="text" class="form-control form-control-sm tagline-input mb-2" id="taglineInput" placeholder="Tagline" oninput="updatePreview()">
                            <div class="row">
                                <div class="col-6">
                                    <label class="small text-muted">X: <span id="posXVal">50</span>%</label>
                                    <input type="range" class="form-range" id="posX" min="0" max="100" value="50" oninput="updatePreview()">
                                </div>
                                <div class="col-6">
                                    <label class="small text-muted">Y: <span id="posYVal">20</span>%</label>
                                    <input type="range" class="form-range" id="posY" min="0" max="100" value="20" oninput="updatePreview()">
                                </div>
                            </div>
                            <button class="btn btn-warning w-100 mt-2" onclick="downloadCard()">
                                <i class="bi bi-download"></i> Download
                            </button>
                        </div>
                    </div>
                    
                    <!-- Preview -->
                    <div class="col-lg-7">
                        <div class="preview-container">
                            <div class="preview-wrapper">
                                <h5 id="previewTitle">PCL Europe - SINGLES</h5>
                                <div class="card-container">
                                    <div class="card-scale">
                                        <div class="player-card-pcl" id="cardPreview"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TEAM TAB -->
            <div class="tab-pane fade" id="teamTab">
                <div class="form-section">
                    <div class="row align-items-center mb-3">
                        <div class="col-md-2">
                            <select class="form-select form-select-sm" id="teamBrand">
                                <option value="pcl">PCL Europe</option>
                                <option value="wpc">WPC Series</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control form-control-sm tagline-input" id="teamTagline" placeholder="Tagline">
                        </div>
                        <div class="col-md-2">
                            <label class="small text-muted">X: <span id="teamXVal">50</span>%</label>
                            <input type="range" class="form-range" id="teamPosX" min="0" max="100" value="50" oninput="document.getElementById('teamXVal').textContent=this.value">
                        </div>
                        <div class="col-md-2">
                            <label class="small text-muted">Y: <span id="teamYVal">20</span>%</label>
                            <input type="range" class="form-range" id="teamPosY" min="0" max="100" value="20" oninput="document.getElementById('teamYVal').textContent=this.value">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-warning w-100" onclick="downloadTeamZip()">
                                <i class="bi bi-download"></i> Download ZIP
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        {% for reg in registrations %}
                        <div class="col-4 col-md-2 mb-2 text-center">
                            {% if reg.photo_filename %}
                            <img src="{{ reg.photo_filename }}" class="rounded-circle mb-1" width="50" height="50" style="object-fit:cover;">
                            {% else %}
                            <div class="rounded-circle bg-secondary mx-auto mb-1" style="width:50px;height:50px;"></div>
                            {% endif %}
                            <div class="small text-warning">{{ reg.shirt_name or reg.first_name|upper }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ==================== VENUES ====================
// Venues werden aus externen Dateien geladen
var venues = {
    'none': {
        name: '',
        svg: '',
        taglineWPC: '',
        taglinePCL: '',
        badge: 'Kein Venue'
    }
};
</script>

<!-- Venue-Dateien (einzeln bearbeitbar) -->
<script src="{{ url_for('static', filename='venues/malaga.js') }}"></script>
<script src="{{ url_for('static', filename='venues/istanbul.js') }}"></script>
<script src="{{ url_for('static', filename='venues/algarve.js') }}"></script>
<script src="{{ url_for('static', filename='venues/alba.js') }}"></script>
<script src="{{ url_for('static', filename='venues/marrakech.js') }}"></script>

<script>
var currentVenue = 'malaga';

// ==================== DATA ====================
var teamData = {
    flag: '{{ team.country_flag }}',
    country: '{{ team.country_name }}',
    age: '{{ team.age_category }}'
};

var players = [
    {% for reg in registrations %}
    {
        id: {{ reg.id }},
        shirt: {{ (reg.shirt_name or reg.first_name|upper)|tojson }},
        name: {{ (reg.first_name ~ ' ' ~ reg.last_name)|tojson }},
        gender: {{ reg.gender|tojson }},
        instagram: {{ (reg.instagram or '')|tojson }},
        dupr: {{ (reg.dupr_rating or '-')|tojson }},
        photo: {{ (reg.photo_filename or '')|tojson }}
    },
    {% endfor %}
];

var currentCategory = 'singles';
var selectedPlayers = [];
var categoryConfig = {
    'singles': { min: 1, max: 1, label: 'SINGLES', hint: 'Select 1 player' },
    'mens-doubles': { min: 2, max: 2, label: "MEN'S DOUBLES", hint: 'Select 2 males', gender: 'male' },
    'womens-doubles': { min: 2, max: 2, label: "WOMEN'S DOUBLES", hint: 'Select 2 females', gender: 'female' },
    'mixed-doubles': { min: 2, max: 2, label: 'MIXED DOUBLES', hint: '1 male + 1 female' }
};

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', function() {
    // Load saved venue
    var saved = localStorage.getItem('wpc_venue');
    if (saved && venues[saved]) {
        currentVenue = saved;
    }
    document.getElementById('venueSelect').value = currentVenue;
    
    // Set tagline based on brand
    updateTaglineForBrand();
    
    updateBadge();
    updatePreview();
});

function updateTaglineForBrand() {
    var brand = document.getElementById('brandSelect').value;
    var v = venues[currentVenue];
    var tagline = brand === 'wpc' ? (v.taglineWPC || '') : (v.taglinePCL || '');
    document.getElementById('taglineInput').value = tagline;
    document.getElementById('teamTagline').value = tagline;
}

// ==================== VENUE ====================
function changeVenue() {
    currentVenue = document.getElementById('venueSelect').value;
    localStorage.setItem('wpc_venue', currentVenue);
    
    updateTaglineForBrand();
    
    updateBadge();
    updatePreview();
}

function changeBrand() {
    updateTaglineForBrand();
    updatePreview();
}

function updateBadge() {
    var badge = document.getElementById('venueBadge');
    var text = document.getElementById('venueBadgeText');
    var v = venues[currentVenue];
    
    text.textContent = v.badge;
    badge.className = currentVenue === 'none' ? 'venue-badge no-venue' : 'venue-badge';
}

// ==================== CATEGORY ====================
function selectCategory(cat, btn) {
    currentCategory = cat;
    selectedPlayers = [];
    document.querySelectorAll('.category-btn').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');
    document.getElementById('categoryHint').textContent = categoryConfig[cat].hint;
    document.querySelectorAll('#playerList .player-select-card').forEach(function(c) { c.classList.remove('selected'); });
    updatePreview();
}

// ==================== PLAYER ====================
function togglePlayer(el, id) {
    var cfg = categoryConfig[currentCategory];
    var player = players.find(function(p) { return p.id === id; });
    var idx = selectedPlayers.findIndex(function(p) { return p.id === id; });
    
    if (idx > -1) {
        selectedPlayers.splice(idx, 1);
        el.classList.remove('selected');
    } else {
        if (selectedPlayers.length >= cfg.max) { alert('Max ' + cfg.max); return; }
        if (cfg.gender && player.gender !== cfg.gender) { alert('Select ' + cfg.gender); return; }
        if (currentCategory === 'mixed-doubles') {
            var m = selectedPlayers.filter(function(p) { return p.gender === 'male'; }).length;
            var f = selectedPlayers.filter(function(p) { return p.gender === 'female'; }).length;
            if (player.gender === 'male' && m >= 1) { alert('Need female'); return; }
            if (player.gender === 'female' && f >= 1) { alert('Need male'); return; }
        }
        selectedPlayers.push(player);
        el.classList.add('selected');
    }
    updatePreview();
}

// ==================== BUILD CARD ====================
function buildCard(brand, category, pList, tagline, posX, posY) {
    var cfg = categoryConfig[category];
    var v = venues[currentVenue];
    var logo = brand === 'pcl' ? 'PCL <span>EUROPE</span>' : 'WPC <span>SERIES</span>';
    var bgPos = posX + '% ' + posY + '%';
    var isDoubles = category !== 'singles' && pList.length === 2;
    
    var html = '';
    
    // Venue silhouette
    if (v.svg) {
        html += '<div class="venue-silhouette">' + v.svg + '</div>';
    }
    
    // Header
    html += '<div class="header">' +
        '<div class="logo-text">' + logo + '</div>' +
        '<div class="flag-container"><span class="flag">' + teamData.flag + '</span><span class="country-name">' + teamData.country + '</span></div>' +
        '<span class="age-category">' + teamData.age + '</span></div>' +
        '<div class="category-badge">' + cfg.label + '</div>';
    
    if (isDoubles) {
        html += '<div class="doubles-photos">';
        for (var i = 0; i < 2; i++) {
            var p = pList[i];
            if (p.photo) {
                html += '<div class="player-photo" style="background-image:url(\'' + p.photo + '\');background-position:' + bgPos + ';"></div>';
            } else {
                html += '<div class="player-photo"><div class="photo-placeholder"><i class="bi bi-person"></i></div></div>';
            }
        }
        html += '</div>';
        html += '<div class="info-section">' +
            '<div class="shirt-name">' + pList[0].shirt + ' & ' + pList[1].shirt + '</div>' +
            '<div class="full-name">' + pList[0].name + ' & ' + pList[1].name + '</div>' +
            (tagline ? '<div class="tagline">' + tagline + '</div>' : '') +
            (v.name ? '<div class="venue-name">' + v.name + '</div>' : '') +
            '<div class="social">' +
            (pList[0].instagram ? '<span><i class="bi bi-instagram"></i> @' + pList[0].instagram + '</span>' : '') +
            (pList[1].instagram ? '<span><i class="bi bi-instagram"></i> @' + pList[1].instagram + '</span>' : '') +
            '</div></div>';
    } else if (pList.length >= 1) {
        var p = pList[0];
        if (p.photo) {
            html += '<div class="photo-circle" style="background-image:url(\'' + p.photo + '\');background-position:' + bgPos + ';"></div>';
        } else {
            html += '<div class="photo-circle"><div class="photo-placeholder"><i class="bi bi-person"></i></div></div>';
        }
        html += '<div class="info-section">' +
            '<div class="shirt-name">' + p.shirt + '</div>' +
            '<div class="full-name">' + p.name + '</div>' +
            (tagline ? '<div class="tagline">' + tagline + '</div>' : '') +
            (v.name ? '<div class="venue-name">' + v.name + '</div>' : '') +
            '<div class="social">' +
            (p.instagram ? '<span><i class="bi bi-instagram"></i> @' + p.instagram + '</span>' : '') +
            (p.dupr !== '-' ? '<span>DUPR: ' + p.dupr + '</span>' : '') +
            '</div></div>';
    } else {
        html += '<div class="photo-circle"><div class="photo-placeholder"><i class="bi bi-person"></i></div></div>' +
            '<div class="info-section"><div class="shirt-name">SELECT</div><div class="full-name">Choose player</div>' +
            (v.name ? '<div class="venue-name">' + v.name + '</div>' : '') + '</div>';
    }
    return html;
}

// ==================== PREVIEW ====================
function updatePreview() {
    var brand = document.getElementById('brandSelect').value;
    var tagline = document.getElementById('taglineInput').value;
    var posX = document.getElementById('posX').value;
    var posY = document.getElementById('posY').value;
    document.getElementById('posXVal').textContent = posX;
    document.getElementById('posYVal').textContent = posY;
    
    var cfg = categoryConfig[currentCategory];
    var isDoubles = currentCategory !== 'singles' && selectedPlayers.length === 2;
    
    document.getElementById('previewTitle').textContent = (brand === 'pcl' ? 'PCL Europe' : 'WPC Series') + ' - ' + cfg.label;
    
    var preview = document.getElementById('cardPreview');
    preview.className = 'player-card-' + brand + (isDoubles ? ' doubles-card' : '');
    preview.innerHTML = buildCard(brand, currentCategory, selectedPlayers, tagline, posX, posY);
}

// ==================== DOWNLOAD ====================
async function downloadCard() {
    var cfg = categoryConfig[currentCategory];
    if (selectedPlayers.length < cfg.min) { alert('Select ' + cfg.min + ' player(s)'); return; }
    
    var card = document.getElementById('cardPreview');
    var clone = card.cloneNode(true);
    clone.style.cssText = 'transform:none;position:fixed;left:-9999px;width:1080px;height:1080px;';
    document.body.appendChild(clone);
    
    try {
        var canvas = await html2canvas(clone, { width: 1080, height: 1080, scale: 1, useCORS: true, allowTaint: true });
        var brand = document.getElementById('brandSelect').value;
        var venuePart = currentVenue !== 'none' ? '_' + venues[currentVenue].badge : '';
        var names = selectedPlayers.map(function(p) { return p.shirt; }).join('_');
        var link = document.createElement('a');
        link.download = brand.toUpperCase() + venuePart + '_' + currentCategory + '_' + names + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    } finally {
        document.body.removeChild(clone);
    }
}

async function downloadTeamZip() {
    if (players.length === 0) { alert('No players'); return; }
    
    var zip = new JSZip();
    var brand = document.getElementById('teamBrand').value;
    var tagline = document.getElementById('teamTagline').value;
    var posX = document.getElementById('teamPosX').value;
    var posY = document.getElementById('teamPosY').value;
    
    for (var i = 0; i < players.length; i++) {
        var p = players[i];
        var temp = document.createElement('div');
        temp.className = 'player-card-' + brand;
        temp.innerHTML = buildCard(brand, 'singles', [p], tagline, posX, posY);
        temp.style.cssText = 'position:fixed;left:-9999px;width:1080px;height:1080px;';
        document.body.appendChild(temp);
        
        try {
            var canvas = await html2canvas(temp, { width: 1080, height: 1080, scale: 1, useCORS: true, allowTaint: true });
            var data = canvas.toDataURL('image/png').split(',')[1];
            var num = String(i + 1).padStart(2, '0');
            zip.file(num + '_' + p.shirt + '.png', data, { base64: true });
        } finally {
            document.body.removeChild(temp);
        }
    }
    
    var blob = await zip.generateAsync({ type: 'blob' });
    var venuePart = currentVenue !== 'none' ? '_' + venues[currentVenue].badge : '';
    var link = document.createElement('a');
    link.download = brand.toUpperCase() + venuePart + '_' + teamData.country + '_' + teamData.age + '.zip';
    link.href = URL.createObjectURL(blob);
    link.click();
}
</script>
{% endblock %}