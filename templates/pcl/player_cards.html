{% extends "base.html" %}

{% block title %}Player Cards - {{ team.country_flag }} {{ team.country_name }} {{ team.age_category }}{% endblock %}

{% block content %}
<style>
    .generator-container {
        background: #1a1a2e;
        color: white;
        min-height: 100vh;
        margin: -20px;
        padding: 20px;
    }
    
    .card-scale {
        transform: scale(0.333);
        transform-origin: top left;
    }
    
    .card-container {
        width: 360px;
        height: 360px;
        overflow: hidden;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    
    /* ==================== PCL EUROPE CARD ==================== */
    .player-card-pcl {
        width: 1080px;
        height: 1080px;
        background: linear-gradient(135deg, #1a4a5e 0%, #2d6a7e 25%, #e86c3a 75%, #f4a03a 100%);
        position: relative;
        overflow: hidden;
        font-family: 'Montserrat', sans-serif;
    }
    
    .player-card-pcl .header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 140px;
        background: rgba(0,0,0,0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 50px;
        z-index: 10;
    }
    
    .player-card-pcl .logo-text {
        color: white;
        font-size: 42px;
        font-weight: 900;
        letter-spacing: 2px;
    }
    
    .player-card-pcl .logo-text span {
        color: #f4a03a;
    }
    
    .player-card-pcl .flag-container {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .player-card-pcl .flag {
        font-size: 60px;
    }
    
    .player-card-pcl .country-name {
        font-size: 28px;
        font-weight: 700;
        color: white;
        text-transform: uppercase;
    }
    
    .player-card-pcl .age-category {
        background: #f4a03a;
        color: #1a1a2e;
        padding: 8px 25px;
        border-radius: 25px;
        font-size: 32px;
        font-weight: 900;
    }
    
    .player-card-pcl .category-badge {
        position: absolute;
        top: 155px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        color: #f4a03a;
        padding: 10px 40px;
        border-radius: 30px;
        font-size: 28px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
        z-index: 10;
    }
    
    /* Photo container - uses overflow hidden + transform for positioning */
    .player-card-pcl .photo-container {
        position: absolute;
        top: 160px;
        left: 50%;
        transform: translateX(-50%);
        width: 450px;
        height: 450px;
        border-radius: 50%;
        border: 8px solid rgba(255,255,255,0.3);
        overflow: hidden;
        background: #2d6a7e;
    }
    
    .player-card-pcl .photo-inner {
        position: absolute;
        width: 200%;
        height: 200%;
        left: -50%;
        top: -50%;
    }
    
    .player-card-pcl .photo-inner img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .player-card-pcl .photo-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 150px;
        color: rgba(255,255,255,0.3);
    }
    
    .player-card-pcl .info-section {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 380px;
        background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 60%, transparent 100%);
        padding: 120px 50px 40px;
        text-align: center;
        z-index: 5;
    }
    
    .player-card-pcl .shirt-name {
        font-size: 72px;
        font-weight: 900;
        color: #f4a03a;
        text-transform: uppercase;
        letter-spacing: 3px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .player-card-pcl .full-name {
        font-size: 32px;
        font-weight: 400;
        color: white;
        margin-top: 5px;
    }
    
    .player-card-pcl .tagline {
        font-size: 28px;
        color: #f4a03a;
        margin-top: 15px;
        font-weight: 700;
        font-style: italic;
    }
    
    .player-card-pcl .social {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 20px;
        font-size: 26px;
        color: #f4a03a;
    }
    
    .player-card-pcl .social span {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* PCL DOUBLES */
    .player-card-pcl.doubles-card .photo-container {
        display: none;
    }
    
    .player-card-pcl.doubles-card .doubles-photos {
        position: absolute;
        top: 200px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 30px;
        z-index: 5;
    }
    
    .player-card-pcl.doubles-card .doubles-photos .player-photo {
        width: 320px;
        height: 320px;
        border-radius: 50%;
        border: 6px solid rgba(255,255,255,0.3);
        overflow: hidden;
        background: rgba(0,0,0,0.3);
        position: relative;
    }
    
    .player-card-pcl.doubles-card .doubles-photos .photo-inner {
        position: absolute;
        width: 200%;
        height: 200%;
        left: -50%;
        top: -50%;
    }
    
    .player-card-pcl.doubles-card .doubles-photos .photo-inner img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .player-card-pcl.doubles-card .doubles-photos .photo-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 100px;
        color: rgba(255,255,255,0.3);
    }
    
    .player-card-pcl.doubles-card .info-section {
        height: 420px;
        padding-top: 140px;
    }
    
    .player-card-pcl.doubles-card .shirt-name {
        font-size: 56px;
    }
    
    .player-card-pcl.doubles-card .full-name {
        font-size: 28px;
    }
    
    /* ==================== WPC SERIES CARD ==================== */
    .player-card-wpc {
        width: 1080px;
        height: 1080px;
        background: linear-gradient(135deg, #4a7c3f 0%, #5a9a4a 50%, #3d6a32 100%);
        position: relative;
        overflow: hidden;
        font-family: 'Montserrat', sans-serif;
    }
    
    .player-card-wpc .header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 140px;
        background: rgba(0,0,0,0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 50px;
        z-index: 10;
    }
    
    .player-card-wpc .logo-text {
        color: white;
        font-size: 42px;
        font-weight: 900;
        letter-spacing: 2px;
    }
    
    .player-card-wpc .logo-text span {
        color: #f4a03a;
    }
    
    .player-card-wpc .flag-container {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .player-card-wpc .flag {
        font-size: 60px;
    }
    
    .player-card-wpc .country-name {
        font-size: 28px;
        font-weight: 700;
        color: white;
        text-transform: uppercase;
    }
    
    .player-card-wpc .age-category {
        background: #f4a03a;
        color: #1a1a2e;
        padding: 8px 25px;
        border-radius: 25px;
        font-size: 32px;
        font-weight: 900;
    }
    
    .player-card-wpc .category-badge {
        position: absolute;
        top: 155px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        color: #f4a03a;
        padding: 10px 40px;
        border-radius: 30px;
        font-size: 28px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
        z-index: 10;
    }
    
    .player-card-wpc .photo-container {
        position: absolute;
        top: 160px;
        left: 50%;
        transform: translateX(-50%);
        width: 450px;
        height: 450px;
        border-radius: 50%;
        border: 8px solid rgba(255,255,255,0.3);
        overflow: hidden;
        background: #3d6a32;
    }
    
    .player-card-wpc .photo-inner {
        position: absolute;
        width: 200%;
        height: 200%;
        left: -50%;
        top: -50%;
    }
    
    .player-card-wpc .photo-inner img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .player-card-wpc .photo-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 150px;
        color: rgba(255,255,255,0.3);
    }
    
    .player-card-wpc .info-section {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 380px;
        background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 60%, transparent 100%);
        padding: 120px 50px 40px;
        text-align: center;
        z-index: 5;
    }
    
    .player-card-wpc .shirt-name {
        font-size: 72px;
        font-weight: 900;
        color: #f4a03a;
        text-transform: uppercase;
        letter-spacing: 3px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .player-card-wpc .full-name {
        font-size: 32px;
        font-weight: 400;
        color: white;
        margin-top: 5px;
    }
    
    .player-card-wpc .tagline {
        font-size: 28px;
        color: #f4a03a;
        margin-top: 15px;
        font-weight: 700;
        font-style: italic;
    }
    
    .player-card-wpc .social {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 20px;
        font-size: 26px;
        color: #f4a03a;
    }
    
    .player-card-wpc .social span {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* WPC DOUBLES */
    .player-card-wpc.doubles-card .photo-container {
        display: none;
    }
    
    .player-card-wpc.doubles-card .doubles-photos {
        position: absolute;
        top: 200px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 30px;
        z-index: 5;
    }
    
    .player-card-wpc.doubles-card .doubles-photos .player-photo {
        width: 320px;
        height: 320px;
        border-radius: 50%;
        border: 6px solid rgba(255,255,255,0.3);
        overflow: hidden;
        background: rgba(0,0,0,0.3);
        position: relative;
    }
    
    .player-card-wpc.doubles-card .doubles-photos .photo-inner {
        position: absolute;
        width: 200%;
        height: 200%;
        left: -50%;
        top: -50%;
    }
    
    .player-card-wpc.doubles-card .doubles-photos .photo-inner img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .player-card-wpc.doubles-card .doubles-photos .photo-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 100px;
        color: rgba(255,255,255,0.3);
    }
    
    .player-card-wpc.doubles-card .info-section {
        height: 420px;
        padding-top: 140px;
    }
    
    .player-card-wpc.doubles-card .shirt-name {
        font-size: 56px;
    }
    
    .player-card-wpc.doubles-card .full-name {
        font-size: 28px;
    }
    
    /* ==================== UI STYLES ==================== */
    .form-section {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
    }
    
    .form-section h5 {
        color: #ffd700;
        margin-bottom: 15px;
    }
    
    .category-btn {
        padding: 12px 20px;
        border: 2px solid #555;
        background: transparent;
        color: white;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s;
        margin: 5px;
        font-size: 14px;
    }
    
    .category-btn:hover {
        border-color: #f4a03a;
        color: #f4a03a;
    }
    
    .category-btn.active {
        background: #f4a03a;
        color: #1a1a2e;
        border-color: #f4a03a;
    }
    
    .player-select-card {
        background: rgba(255,255,255,0.05);
        border: 2px solid transparent;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .player-select-card:hover {
        border-color: #f4a03a;
    }
    
    .player-select-card.selected {
        border-color: #f4a03a;
        background: rgba(244,160,58,0.2);
    }
    
    .player-select-card img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .player-select-card .placeholder-img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .preview-container {
        display: flex;
        justify-content: center;
        gap: 30px;
        flex-wrap: wrap;
    }
    
    .preview-wrapper {
        text-align: center;
    }
    
    .preview-wrapper h5 {
        color: #ffd700;
        margin-bottom: 10px;
    }
    
    .nav-tabs .nav-link {
        color: #aaa;
        background: transparent;
        border: none;
        padding: 15px 25px;
    }
    
    .nav-tabs .nav-link.active {
        color: #f4a03a;
        background: rgba(244,160,58,0.2);
        border-bottom: 3px solid #f4a03a;
    }
    
    .nav-tabs .nav-link:hover {
        color: #f4a03a;
    }
    
    .tagline-input {
        background: rgba(255,255,255,0.1);
        border: 1px solid #555;
        color: white;
        border-radius: 8px;
    }
    
    .tagline-input:focus {
        background: rgba(255,255,255,0.15);
        border-color: #f4a03a;
        color: white;
        box-shadow: 0 0 0 2px rgba(244,160,58,0.25);
    }
    
    .tagline-input::placeholder {
        color: #888;
    }
    
    .form-range::-webkit-slider-thumb {
        background: #f4a03a;
    }
    
    .form-range::-moz-range-thumb {
        background: #f4a03a;
        border: none;
    }
</style>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<div class="generator-container">
    <div class="container-fluid">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <a href="{{ url_for('pcl.admin_team_detail', team_id=team.id) }}" class="btn btn-outline-light btn-sm mb-2">
                    <i class="bi bi-arrow-left"></i> Back to Team
                </a>
                <h2 class="mb-0">
                    <i class="bi bi-card-image"></i> Player Card Generator
                </h2>
                <p class="text-muted mb-0">{{ team.country_flag }} {{ team.country_name }} {{ team.age_category }} - {{ team.tournament.name }}</p>
            </div>
        </div>
        
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#categoryTab">
                    <i class="bi bi-trophy"></i> Create Cards
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#teamTab">
                    <i class="bi bi-people"></i> Download All
                </button>
            </li>
        </ul>
        
        <div class="tab-content">
            <!-- ==================== CREATE CARDS TAB ==================== -->
            <div class="tab-pane fade show active" id="categoryTab">
                <div class="row">
                    <!-- Left Panel: Controls -->
                    <div class="col-lg-5">
                        <!-- Category Selection -->
                        <div class="form-section">
                            <h5><i class="bi bi-trophy"></i> 1. Select Category</h5>
                            <div class="d-flex flex-wrap mb-3">
                                <button class="category-btn active" onclick="selectCategory('singles', this)">
                                    <i class="bi bi-person"></i> Singles
                                </button>
                                <button class="category-btn" onclick="selectCategory('mens-doubles', this)">
                                    <i class="bi bi-people"></i> Men's Doubles
                                </button>
                                <button class="category-btn" onclick="selectCategory('womens-doubles', this)">
                                    <i class="bi bi-people"></i> Women's Doubles
                                </button>
                                <button class="category-btn" onclick="selectCategory('mixed-doubles', this)">
                                    <i class="bi bi-people"></i> Mixed Doubles
                                </button>
                            </div>
                            
                            <div class="row">
                                <div class="col-6">
                                    <label class="text-muted small">Brand</label>
                                    <select class="form-select form-select-sm" id="brandSelect" onchange="updatePreview()">
                                        <option value="pcl">PCL Europe</option>
                                        <option value="wpc">WPC Series</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="text-muted small">Required</label>
                                    <div class="text-warning" id="categoryHint">Select 1 player</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Player Selection -->
                        <div class="form-section">
                            <h5><i class="bi bi-person-check"></i> 2. Select Player(s)</h5>
                            <div style="max-height: 200px; overflow-y: auto;" id="playerList">
                                {% for reg in registrations %}
                                <div class="player-select-card" 
                                     onclick="togglePlayer(this, {{ reg.id }})" 
                                     data-player-id="{{ reg.id }}"
                                     data-gender="{{ reg.gender }}">
                                    <div class="d-flex align-items-center gap-3">
                                        {% if reg.photo_filename %}
                                        <img src="{{ reg.photo_filename }}">
                                        {% else %}
                                        <div class="placeholder-img"><i class="bi bi-person"></i></div>
                                        {% endif %}
                                        <div class="flex-grow-1">
                                            <strong>{{ reg.shirt_name or reg.first_name|upper }}</strong>
                                            <span class="badge bg-{{ 'primary' if reg.gender == 'male' else 'danger' }} ms-1">
                                                {{ '♂' if reg.gender == 'male' else '♀' }}
                                            </span>
                                            <br>
                                            <small class="text-muted">{{ reg.first_name }} {{ reg.last_name }}</small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Card Options -->
                        <div class="form-section">
                            <h5><i class="bi bi-pencil"></i> 3. Card Options</h5>
                            <div class="mb-3">
                                <label class="text-muted small">Tagline</label>
                                <input type="text" 
                                       class="form-control tagline-input" 
                                       id="taglineInput" 
                                       placeholder="e.g. Signed for WPC Open Malaga"
                                       oninput="updatePreview()">
                            </div>
                            
                            <div class="mb-2">
                                <label class="text-muted small">Photo: Left ↔ Right</label>
                                <input type="range" class="form-range" id="photoX" min="0" max="100" value="50" oninput="updatePreview()">
                            </div>
                            
                            <div class="mb-3">
                                <label class="text-muted small">Photo: Top ↔ Bottom</label>
                                <input type="range" class="form-range" id="photoY" min="0" max="100" value="25" oninput="updatePreview()">
                            </div>
                            
                            <button class="btn btn-warning w-100" onclick="downloadCard()">
                                <i class="bi bi-download"></i> Download Card
                            </button>
                        </div>
                    </div>
                    
                    <!-- Right Panel: Preview -->
                    <div class="col-lg-7">
                        <div class="preview-container">
                            <div class="preview-wrapper">
                                <h5 id="previewTitle">PCL Europe - SINGLES</h5>
                                <div class="card-container">
                                    <div class="card-scale">
                                        <div class="player-card-pcl" id="cardPreview">
                                            <!-- Will be populated by JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== DOWNLOAD ALL TAB ==================== -->
            <div class="tab-pane fade" id="teamTab">
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h5 class="mb-1"><i class="bi bi-people"></i> Full Team Export</h5>
                            <p class="text-muted mb-0">Download all {{ registrations|length }} player cards as a ZIP file</p>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <select class="form-select" id="teamBrandSelect" style="width: auto;">
                                <option value="pcl">PCL Europe</option>
                                <option value="wpc">WPC Series</option>
                            </select>
                            <button class="btn btn-warning btn-lg" onclick="downloadTeamZip()">
                                <i class="bi bi-download"></i> Download All (ZIP)
                            </button>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="text-muted small">Tagline for all cards</label>
                            <input type="text" class="form-control tagline-input" id="teamTagline" placeholder="Optional">
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Photo: Left ↔ Right</label>
                            <input type="range" class="form-range" id="teamPhotoX" min="0" max="100" value="50">
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Photo: Top ↔ Bottom</label>
                            <input type="range" class="form-range" id="teamPhotoY" min="0" max="100" value="25">
                        </div>
                    </div>
                    
                    <div class="row">
                        {% for reg in registrations %}
                        <div class="col-md-4 col-lg-3 mb-3">
                            <div class="card bg-dark text-white h-100">
                                <div class="card-body text-center">
                                    {% if reg.photo_filename %}
                                    <img src="{{ reg.photo_filename }}" class="rounded-circle mb-2" width="80" height="80" style="object-fit: cover;">
                                    {% else %}
                                    <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 80px; height: 80px;">
                                        <i class="bi bi-person fs-3"></i>
                                    </div>
                                    {% endif %}
                                    <h6 class="text-warning mb-1">{{ reg.shirt_name or reg.first_name|upper }}</h6>
                                    <small>{{ reg.first_name }} {{ reg.last_name }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ==================== DATA ====================
    var teamData = {
        flag: '{{ team.country_flag }}',
        country: '{{ team.country_name }}',
        age: '{{ team.age_category }}'
    };
    
    var players = [
        {% for reg in registrations %}
        {
            id: {{ reg.id }},
            shirt: {{ (reg.shirt_name or reg.first_name|upper)|tojson }},
            name: {{ (reg.first_name ~ ' ' ~ reg.last_name)|tojson }},
            gender: {{ reg.gender|tojson }},
            instagram: {{ (reg.instagram or '')|tojson }},
            dupr: {{ (reg.dupr_rating or '-')|tojson }},
            photo: {{ (reg.photo_filename or '')|tojson }}
        },
        {% endfor %}
    ];
    
    // ==================== STATE ====================
    var currentCategory = 'singles';
    var selectedPlayers = [];
    
    var categoryConfig = {
        'singles': { min: 1, max: 1, label: 'SINGLES', hint: 'Select 1 player' },
        'mens-doubles': { min: 2, max: 2, label: "MEN'S DOUBLES", hint: 'Select 2 male players', gender: 'male' },
        'womens-doubles': { min: 2, max: 2, label: "WOMEN'S DOUBLES", hint: 'Select 2 female players', gender: 'female' },
        'mixed-doubles': { min: 2, max: 2, label: 'MIXED DOUBLES', hint: 'Select 1 male + 1 female' }
    };
    
    // ==================== INIT ====================
    document.addEventListener('DOMContentLoaded', function() {
        updatePreview();
    });
    
    // ==================== CATEGORY SELECTION ====================
    function selectCategory(cat, btn) {
        currentCategory = cat;
        selectedPlayers = [];
        
        var buttons = document.querySelectorAll('.category-btn');
        for (var i = 0; i < buttons.length; i++) {
            buttons[i].classList.remove('active');
        }
        btn.classList.add('active');
        
        document.getElementById('categoryHint').textContent = categoryConfig[cat].hint;
        
        var cards = document.querySelectorAll('#playerList .player-select-card');
        for (var i = 0; i < cards.length; i++) {
            cards[i].classList.remove('selected');
        }
        
        updatePreview();
    }
    
    // ==================== PLAYER SELECTION ====================
    function togglePlayer(el, id) {
        var cfg = categoryConfig[currentCategory];
        var player = null;
        for (var i = 0; i < players.length; i++) {
            if (players[i].id === id) {
                player = players[i];
                break;
            }
        }
        
        var idx = -1;
        for (var i = 0; i < selectedPlayers.length; i++) {
            if (selectedPlayers[i].id === id) {
                idx = i;
                break;
            }
        }
        
        if (idx > -1) {
            selectedPlayers.splice(idx, 1);
            el.classList.remove('selected');
        } else {
            if (selectedPlayers.length >= cfg.max) {
                alert('Maximum ' + cfg.max + ' player(s) for ' + cfg.label);
                return;
            }
            
            if (cfg.gender && player.gender !== cfg.gender) {
                alert('Please select ' + cfg.gender + ' players for ' + cfg.label);
                return;
            }
            
            if (currentCategory === 'mixed-doubles') {
                var males = 0, females = 0;
                for (var i = 0; i < selectedPlayers.length; i++) {
                    if (selectedPlayers[i].gender === 'male') males++;
                    if (selectedPlayers[i].gender === 'female') females++;
                }
                if (player.gender === 'male' && males >= 1) {
                    alert('Already have 1 male. Select a female.');
                    return;
                }
                if (player.gender === 'female' && females >= 1) {
                    alert('Already have 1 female. Select a male.');
                    return;
                }
            }
            
            selectedPlayers.push(player);
            el.classList.add('selected');
        }
        
        updatePreview();
    }
    
    // ==================== BUILD CARD HTML ====================
    function buildCardHTML(brand, category, playersList, tagline, posX, posY) {
        var cfg = categoryConfig[category];
        var logoText = brand === 'pcl' ? 'PCL <span>EUROPE</span>' : 'WPC <span>SERIES</span>';
        var isDoubles = category !== 'singles';
        
        // Calculate transform for photo positioning
        // posX: 0=show left edge, 50=center, 100=show right edge
        // posY: 0=show top edge, 50=center, 100=show bottom edge
        var translateX = -posX;
        var translateY = -posY;
        var transform = 'translate(' + translateX + '%, ' + translateY + '%)';
        
        var html = '';
        
        // Header
        html += '<div class="header">';
        html += '<div class="logo-text">' + logoText + '</div>';
        html += '<div class="flag-container">';
        html += '<span class="flag">' + teamData.flag + '</span>';
        html += '<span class="country-name">' + teamData.country + '</span>';
        html += '</div>';
        html += '<span class="age-category">' + teamData.age + '</span>';
        html += '</div>';
        
        // Category badge
        html += '<div class="category-badge">' + cfg.label + '</div>';
        
        // Photos
        if (isDoubles && playersList.length === 2) {
            html += '<div class="doubles-photos">';
            for (var i = 0; i < 2; i++) {
                var p = playersList[i];
                html += '<div class="player-photo">';
                if (p.photo) {
                    html += '<div class="photo-inner" style="transform:' + transform + '">';
                    html += '<img src="' + p.photo + '">';
                    html += '</div>';
                } else {
                    html += '<div class="photo-placeholder"><i class="bi bi-person"></i></div>';
                }
                html += '</div>';
            }
            html += '</div>';
        } else if (playersList.length >= 1) {
            var p = playersList[0];
            html += '<div class="photo-container">';
            if (p.photo) {
                html += '<div class="photo-inner" style="transform:' + transform + '">';
                html += '<img src="' + p.photo + '">';
                html += '</div>';
            } else {
                html += '<div class="photo-placeholder"><i class="bi bi-person"></i></div>';
            }
            html += '</div>';
        } else {
            html += '<div class="photo-container">';
            html += '<div class="photo-placeholder"><i class="bi bi-person"></i></div>';
            html += '</div>';
        }
        
        // Info section
        html += '<div class="info-section">';
        
        if (isDoubles && playersList.length === 2) {
            html += '<div class="shirt-name">' + playersList[0].shirt + ' & ' + playersList[1].shirt + '</div>';
            html += '<div class="full-name">' + playersList[0].name + ' & ' + playersList[1].name + '</div>';
            if (tagline) html += '<div class="tagline">' + tagline + '</div>';
            html += '<div class="social">';
            if (playersList[0].instagram) html += '<span><i class="bi bi-instagram"></i> @' + playersList[0].instagram + '</span>';
            if (playersList[1].instagram) html += '<span><i class="bi bi-instagram"></i> @' + playersList[1].instagram + '</span>';
            html += '</div>';
        } else if (playersList.length >= 1) {
            var p = playersList[0];
            html += '<div class="shirt-name">' + p.shirt + '</div>';
            html += '<div class="full-name">' + p.name + '</div>';
            if (tagline) html += '<div class="tagline">' + tagline + '</div>';
            html += '<div class="social">';
            if (p.instagram) html += '<span><i class="bi bi-instagram"></i> @' + p.instagram + '</span>';
            if (p.dupr !== '-') html += '<span>DUPR: ' + p.dupr + '</span>';
            html += '</div>';
        } else {
            html += '<div class="shirt-name">SELECT PLAYER</div>';
            html += '<div class="full-name">Choose a player from the left</div>';
        }
        
        html += '</div>';
        
        return html;
    }
    
    // ==================== PREVIEW UPDATE ====================
    function updatePreview() {
        var brand = document.getElementById('brandSelect').value;
        var tagline = document.getElementById('taglineInput').value;
        var posX = parseInt(document.getElementById('photoX').value);
        var posY = parseInt(document.getElementById('photoY').value);
        var cfg = categoryConfig[currentCategory];
        var isDoubles = currentCategory !== 'singles';
        
        // Update title
        var brandName = brand === 'pcl' ? 'PCL Europe' : 'WPC Series';
        document.getElementById('previewTitle').textContent = brandName + ' - ' + cfg.label;
        
        // Update card
        var preview = document.getElementById('cardPreview');
        var cardClass = 'player-card-' + brand;
        if (isDoubles && selectedPlayers.length === 2) {
            cardClass += ' doubles-card';
        }
        preview.className = cardClass;
        preview.innerHTML = buildCardHTML(brand, currentCategory, selectedPlayers, tagline, posX, posY);
    }
    
    // ==================== DOWNLOAD SINGLE CARD ====================
    async function downloadCard() {
        var cfg = categoryConfig[currentCategory];
        if (selectedPlayers.length < cfg.min) {
            alert('Please select ' + cfg.min + ' player(s) for ' + cfg.label);
            return;
        }
        
        var card = document.getElementById('cardPreview');
        var clone = card.cloneNode(true);
        clone.style.cssText = 'transform:none;position:fixed;left:-9999px;width:1080px;height:1080px;';
        document.body.appendChild(clone);
        
        try {
            var canvas = await html2canvas(clone, { 
                width: 1080, 
                height: 1080, 
                scale: 1, 
                useCORS: true,
                allowTaint: true,
                backgroundColor: null
            });
            
            var brand = document.getElementById('brandSelect').value;
            var names = '';
            for (var i = 0; i < selectedPlayers.length; i++) {
                if (i > 0) names += '_';
                names += selectedPlayers[i].shirt;
            }
            
            var link = document.createElement('a');
            link.download = brand.toUpperCase() + '_' + currentCategory + '_' + names + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        } finally {
            document.body.removeChild(clone);
        }
    }
    
    // ==================== DOWNLOAD TEAM ZIP ====================
    async function downloadTeamZip() {
        if (players.length === 0) {
            alert('No players in team');
            return;
        }
        
        var zip = new JSZip();
        var brand = document.getElementById('teamBrandSelect').value;
        var tagline = document.getElementById('teamTagline').value;
        var posX = parseInt(document.getElementById('teamPhotoX').value);
        var posY = parseInt(document.getElementById('teamPhotoY').value);
        
        for (var i = 0; i < players.length; i++) {
            var p = players[i];
            
            var temp = document.createElement('div');
            temp.className = 'player-card-' + brand;
            temp.innerHTML = buildCardHTML(brand, 'singles', [p], tagline, posX, posY);
            temp.style.cssText = 'position:fixed;left:-9999px;width:1080px;height:1080px;';
            document.body.appendChild(temp);
            
            try {
                var canvas = await html2canvas(temp, { 
                    width: 1080, 
                    height: 1080, 
                    scale: 1, 
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: null
                });
                var data = canvas.toDataURL('image/png').split(',')[1];
                var num = String(i + 1);
                if (num.length < 2) num = '0' + num;
                zip.file(num + '_' + p.shirt + '.png', data, { base64: true });
            } finally {
                document.body.removeChild(temp);
            }
        }
        
        var blob = await zip.generateAsync({ type: 'blob' });
        var link = document.createElement('a');
        link.download = brand.toUpperCase() + '_' + teamData.country + '_' + teamData.age + '_team.zip';
        link.href = URL.createObjectURL(blob);
        link.click();
    }
</script>
{% endblock %}