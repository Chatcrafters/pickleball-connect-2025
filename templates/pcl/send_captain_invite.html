{% extends "base.html" %}

{% block title %}Send Captain Invite - {{ team.country_flag }} {{ team.country_name }}{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('pcl.admin_dashboard') }}">PCL Admin</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('pcl.admin_tournament_detail', tournament_id=team.tournament_id) }}">{{ team.tournament.name }}</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('pcl.admin_team_detail', team_id=team.id) }}">{{ team.country_name }} {{ team.age_category }}</a></li>
            <li class="breadcrumb-item active">Send Captain Invite</li>
        </ol>
    </nav>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 class="mb-4">
                <i class="bi bi-whatsapp"></i> Send Captain Invitation
            </h1>
            
            <!-- Content Template Badge -->
            <div class="alert alert-success mb-4">
                <i class="bi bi-check-circle-fill"></i> 
                <strong>Content Template aktiv!</strong> 
                Nachrichten werden mit genehmigten WhatsApp Templates gesendet (mit klickbarem Button).
            </div>
            
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">{{ team.country_flag }} {{ team.country_name }} {{ team.age_category }}</h5>
                </div>
                <div class="card-body">
                    <p><strong>Tournament:</strong> {{ team.tournament.name }}</p>
                    <p><strong>Deadline:</strong> {{ team.tournament.registration_deadline.strftime('%d.%m.%Y %H:%M') }}</p>
                    
                    {% if captain_reg %}
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> <strong>Captain found:</strong> 
                        {{ captain_reg.first_name }} {{ captain_reg.last_name }}
                        {% if captain_reg.phone %}
                        ({{ captain_reg.phone }})
                        {% else %}
                        <span class="text-warning">- No phone number!</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> <strong>No captain registered yet!</strong>
                        Enter the captain details manually below.
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-send"></i> Captain Details</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="captain_name" class="form-label">Captain Name *</label>
                                <input type="text" class="form-control" id="captain_name" name="captain_name" 
                                       value="{% if captain_reg %}{{ captain_reg.first_name }}{% endif %}"
                                       placeholder="Max" required>
                                <small class="form-text text-muted">Nur Vorname (wird in der Begr√º√üung verwendet)</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="captain_phone" class="form-label">WhatsApp Number *</label>
                                <input type="tel" class="form-control" id="captain_phone" name="captain_phone" 
                                       value="{% if captain_reg and captain_reg.phone %}{{ captain_reg.phone }}{% endif %}"
                                       placeholder="+49123456789" required>
                                <small class="form-text text-muted">With country code (e.g., +49, +34)</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="language" class="form-label">Message Language *</label>
                            <select class="form-select" id="language" name="language" onchange="updatePreview()">
                                <option value="EN" {% if captain_reg and captain_reg.preferred_language == 'EN' %}selected{% endif %}>üá¨üáß English</option>
                                <option value="DE" {% if captain_reg and captain_reg.preferred_language == 'DE' %}selected{% endif %}>üá©üá™ Deutsch</option>
                                <option value="ES" {% if captain_reg and captain_reg.preferred_language == 'ES' %}selected{% endif %}>üá™üá∏ Espa√±ol</option>
                                <option value="FR" {% if captain_reg and captain_reg.preferred_language == 'FR' %}selected{% endif %}>üá´üá∑ Fran√ßais</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="test_mode" name="test_mode">
                                <label class="form-check-label" for="test_mode">
                                    <strong>Test Mode</strong> (only show in console, don't actually send)
                                </label>
                            </div>
                        </div>

                        <hr>

                        <!-- Preview - WhatsApp Style -->
                        <div class="mb-4">
                            <h6><i class="bi bi-eye"></i> Message Preview (Content Template)</h6>
                            
                            <!-- WhatsApp-style preview container -->
                            <div class="whatsapp-preview">
                                <div class="whatsapp-message">
                                    <div class="message-content" id="previewContent">
                                        <strong>PCL {{ team.tournament.name }} - Team-Kapit√§n Einladung</strong>
                                        <br><br>
                                        Hallo <span class="preview-var">[Name]</span>!
                                        <br><br>
                                        Du wurdest als Kapit√§n f√ºr {{ team.country_flag }} {{ team.country_name }} {{ team.age_category }} ausgew√§hlt!
                                        <br><br>
                                        <strong>Deine Aufgaben:</strong><br>
                                        - Registriere deine Team-Spieler<br>
                                        - Stelle sicher, dass alle Profile vollst√§ndig sind
                                        <br><br>
                                        Dein geheimes Kapit√§n-Dashboard:<br>
                                        <span class="preview-var">[Dashboard Link]</span>
                                        <br><br>
                                        Anmeldeschluss: {{ team.tournament.registration_deadline.strftime('%d.%m.%Y') }}
                                        <br><br>
                                        <small class="text-muted">Sergio Ruiz Caro<br>WPC Series & PCL Europe</small>
                                    </div>
                                    <div class="message-button">
                                        <i class="bi bi-box-arrow-up-right"></i> Zum Captain Dashboard
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('pcl.admin_team_detail', team_id=team.id) }}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-whatsapp"></i> Send Captain Invitation
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Captain Dashboard Link Info -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-link-45deg"></i> Captain Dashboard Link</h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">This link will be sent to the captain:</p>
                    <div class="input-group">
                        <input type="text" class="form-control" id="captainUrl" 
                               value="{{ request.host_url }}pcl/team/{{ team.captain_token }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyUrl()">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.whatsapp-preview {
    background: #e5ddd5;
    padding: 20px;
    border-radius: 10px;
}

.whatsapp-message {
    background: white;
    border-radius: 8px;
    max-width: 400px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    overflow: hidden;
}

.message-content {
    padding: 12px;
    font-size: 14px;
    line-height: 1.4;
}

.message-button {
    background: #f0f0f0;
    padding: 12px;
    text-align: center;
    color: #00a884;
    font-weight: 500;
    border-top: 1px solid #e0e0e0;
    cursor: pointer;
}

.message-button:hover {
    background: #e8e8e8;
}

.preview-var {
    background: #fff3cd;
    padding: 2px 6px;
    border-radius: 4px;
    font-style: italic;
}
</style>

<script>
function copyUrl() {
    const input = document.getElementById('captainUrl');
    input.select();
    document.execCommand('copy');
    
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
    btn.classList.remove('btn-outline-secondary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-secondary');
    }, 2000);
}

// Preview templates for different languages
const templates = {
    'DE': {
        title: 'PCL {{ team.tournament.name }} - Team-Kapit√§n Einladung',
        greeting: 'Hallo',
        selected: 'Du wurdest als Kapit√§n f√ºr {{ team.country_flag }} {{ team.country_name }} {{ team.age_category }} ausgew√§hlt!',
        tasks: 'Deine Aufgaben:',
        task1: 'Registriere deine Team-Spieler',
        task2: 'Stelle sicher, dass alle Profile vollst√§ndig sind',
        dashboard: 'Dein geheimes Kapit√§n-Dashboard:',
        deadline: 'Anmeldeschluss:',
        button: 'Zum Captain Dashboard'
    },
    'EN': {
        title: 'PCL {{ team.tournament.name }} - Team Captain Invitation',
        greeting: 'Hello',
        selected: 'You have been selected as Captain for {{ team.country_flag }} {{ team.country_name }} {{ team.age_category }}!',
        tasks: 'Your tasks:',
        task1: 'Register your team players',
        task2: 'Make sure all profiles are complete',
        dashboard: 'Your secret Captain Dashboard:',
        deadline: 'Registration deadline:',
        button: 'Open Captain Dashboard'
    },
    'ES': {
        title: 'PCL {{ team.tournament.name }} - Invitaci√≥n Capit√°n de Equipo',
        greeting: '¬°Hola',
        selected: '¬°Has sido seleccionado como Capit√°n de {{ team.country_flag }} {{ team.country_name }} {{ team.age_category }}!',
        tasks: 'Tus tareas:',
        task1: 'Registrar a los jugadores de tu equipo',
        task2: 'Asegurar que todos los perfiles est√©n completos',
        dashboard: 'Tu panel secreto de Capit√°n:',
        deadline: 'Fecha l√≠mite:',
        button: 'Abrir Panel Capit√°n'
    },
    'FR': {
        title: 'PCL {{ team.tournament.name }} - Invitation Capitaine',
        greeting: 'Bonjour',
        selected: 'Vous avez √©t√© s√©lectionn√© comme Capitaine de {{ team.country_flag }} {{ team.country_name }} {{ team.age_category }}!',
        tasks: 'Vos t√¢ches:',
        task1: 'Inscrire les joueurs de votre √©quipe',
        task2: 'V√©rifier que tous les profils sont complets',
        dashboard: 'Votre tableau de bord Capitaine:',
        deadline: 'Date limite:',
        button: 'Ouvrir Dashboard'
    }
};

function updatePreview() {
    const lang = document.getElementById('language').value;
    const t = templates[lang];
    const button = document.querySelector('.message-button');
    
    // Update button text
    button.innerHTML = '<i class="bi bi-box-arrow-up-right"></i> ' + t.button;
    
    // Update content (simplified - in production would update all fields)
    const content = document.getElementById('previewContent');
    content.innerHTML = `
        <strong>${t.title.replace('{{ team.tournament.name }}', '{{ team.tournament.name }}')}</strong>
        <br><br>
        ${t.greeting} <span class="preview-var">[Name]</span>!
        <br><br>
        ${t.selected.replace('{{ team.country_flag }} {{ team.country_name }} {{ team.age_category }}', '{{ team.country_flag }} {{ team.country_name }} {{ team.age_category }}')}
        <br><br>
        <strong>${t.tasks}</strong><br>
        - ${t.task1}<br>
        - ${t.task2}
        <br><br>
        ${t.dashboard}<br>
        <span class="preview-var">[Dashboard Link]</span>
        <br><br>
        ${t.deadline} {{ team.tournament.registration_deadline.strftime('%d.%m.%Y') }}
        <br><br>
        <small class="text-muted">Sergio Ruiz Caro<br>WPC Series & PCL Europe</small>
    `;
}
</script>
{% endblock %}